<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Astronomická předpověď – v0.2.2-p7</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.0/astronomy.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&display=swap" rel="stylesheet"/>
<style>
  :root { --bg:#0b0c10; --panel:#1f2833; --accent:#00ffc3; --border:#3e5363; --text:#dcdcdc; --shadow:0 0 12px rgba(0,255,195,0.5); --green:#00ff88; --greenFill:rgba(0,255,136,0.22); --red:#ff4d4d; --redFill:rgba(255,77,77,0.22); }
  *{box-sizing:border-box}
  body{margin:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:radial-gradient(ellipse at top,#0b0c1a 0%,#1b2c3a 100%);color:var(--text);padding:16px}
  h1{margin:8px 0 16px 0;text-align:center;color:#fff;font-size:2.2rem;text-shadow:0 0 18px var(--accent)}
  /* top bar */
  .topbar{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;z-index:50}
  .menu-container{position:relative;align-self:flex-start}
  .menu-toggle{background:var(--accent);color:#000;font-weight:bold;padding:8px 14px;border-radius:10px;cursor:pointer;border:none;box-shadow:var(--shadow)}
  .menu-dropdown{display:none;position:absolute;top:110%;left:0;background:var(--panel);border:1px solid var(--border);border-radius:10px;min-width:220px;box-shadow:0 8px 16px rgba(0,0,0,.6);overflow:visible}
  .menu-section{padding:6px 0;position:relative}
  .menu-item,.menu-link{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px 16px;color:var(--accent);text-decoration:none;cursor:pointer;white-space:nowrap}
  .menu-item:hover,.menu-link:hover{background:#2e8b57;color:#fff}
  .submenu{display:none;position:absolute;top:0;left:100%;background:var(--panel);border:1px solid var(--border);border-radius:10px;min-width:230px;box-shadow:0 8px 16px rgba(0,0,0,.6);}
  .has-submenu{position:relative}
  .has-submenu:hover>.submenu{display:block}
  .version-tag{position:relative;background:var(--accent);color:#000;font-weight:bold;padding:6px 12px;border-radius:12px;box-shadow:var(--shadow)}
  .version-tag:hover::after{content:"v0.2.2-p7\\A • Graf se hýbe se sliderem\\A • Dvoubarevný (zelená/červená)\\A • Ostatní beze změn";white-space:pre;position:absolute;top:115%;right:0;background:var(--panel);color:var(--accent);font-size:.9em;padding:10px 12px;border-radius:10px;border:1px solid var(--border);box-shadow:0 0 16px rgba(0,255,195,.4);min-width:320px}
  .controls{display:flex;justify-content:center;align-items:center;gap:8px;flex-wrap:wrap;margin:12px 0}
  .input-wrapper{position:relative}
  #cityInput{width:360px;max-width:100%;padding:10px 36px 10px 12px;border-radius:10px;border:2px solid var(--accent);background:#111;color:#00ffc3;font-weight:700;box-shadow:var(--shadow)}
  .btn{background:#7a6cb6;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;box-shadow:0 0 10px rgba(122,108,182,.5)}
  #suggestions{position:absolute;top:100%;left:0;right:0;background:#121212;border:1px solid var(--border);border-radius:10px;list-style:none;padding:0;margin:6px 0 0 0;display:none;overflow:hidden;z-index:30}
  #suggestions li{padding:10px 12px;cursor:pointer;color:var(--text)} #suggestions li:hover{background:#243442}

  /* TOP ROW */
  .top-row{display:grid;grid-template-columns: minmax(300px, 1fr) minmax(280px, 1fr);gap:16px;align-items:start}
  .left-col{display:flex;flex-direction:column;gap:16px}
  .right-col{position:relative}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 2px 12px rgba(0,0,0,.5)}
  .panel strong{color:var(--accent)}
  .kv{display:grid;grid-template-columns:max-content 1fr;gap:6px 10px}

  /* Map panel */
  #mapPanel{padding:0;overflow:hidden}
  #map{width:100%;height:100%}
  .zoom-badge{position:absolute;top:8px;left:8px;background:rgba(0,0,0,0.55);color:#fff;padding:4px 8px;border-radius:999px;font-size:.85em;border:1px solid rgba(255,255,255,.2);z-index:2}
  .map-tip{position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,0.55);color:#fff;padding:6px 8px;border-radius:8px;font-size:.9em;border:1px solid rgba(255,255,255,.2);z-index:2}

  /* Forecast */
  .forecast-day{border:1px solid var(--border);border-radius:10px;overflow:hidden;position:relative}
  .forecast-day h3{margin:0;padding:10px;background:#4b3f72;color:#fff;display:flex;align-items:center;gap:8px;cursor:pointer;position:relative;z-index:2}
  .forecast-content{display:none;padding:10px;position:relative}
  .forecast-scroll-wrapper{position:relative}
  .forecast-scroll{position:relative;display:flex;gap:8px;overflow-x:auto;padding:6px 0;z-index:2}
  /* bg-graph je uvnitř .forecast-scroll -> scrolluje se s hodinami a nepřesahuje */
  .bg-graph{position:absolute;top:0;left:0;z-index:1;pointer-events:none;}
  .forecast-card{min-width:80px;font-size:.9em;background:rgba(44,47,51,0.72);border:1px solid var(--border);border-radius:8px;padding:6px;text-align:center;position:relative;z-index:2}
  .scroll-left,.scroll-right{background:none;border:none;color:#fff;font-size:1.5em;padding:6px 10px;cursor:pointer;position:absolute;top:50%;transform:translateY(-50%);opacity:.6;text-shadow:0 0 6px rgba(255,255,255,.3);z-index:3}
  .scroll-left{left:6px}.scroll-right{right:6px}
  .spinner{display:none;width:44px;height:44px;margin:8px auto;border:6px solid #333;border-top:6px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{100%{transform:rotate(360deg)}}
  .footer{text-align:center;opacity:.8;margin-top:10px;font-size:.95em}
  .small{font-size:.92em;opacity:.9}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#243442;border:1px solid var(--border);margin:4px 6px 0 0}
</style>
</head>
<body>
<div class="topbar">
  <div class="menu-container">
    <button class="menu-toggle" onclick="toggleMenu()">📋 Menu</button>
    <div class="menu-dropdown" id="mainMenu">
      <div class="menu-section">
        <div class="menu-item has-submenu">🗺️ Mapy ▸
          <div class="submenu">
            <a class="menu-link" href="https://www.lightpollutionmap.info" target="_blank">💡 Light Pollution Map</a>
            <a class="menu-link" href="https://www.windy.com" target="_blank">🌬️ Windy</a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="version-tag">v0.2.2-p7</div>
</div>

<h1>🪐 Astronomická předpověď</h1>

<div class="controls">
  <div class="input-wrapper">
    <input id="cityInput" type="text" placeholder="Zadejte město..." oninput="autocompleteCities()"/>
    <ul id="suggestions"></ul>
  </div>
  <button class="btn" onclick="getLocation()">📍 Moje poloha</button>
</div>

<div class="top-row">
  <div class="left-col" id="leftTop">
    <div class="panel">
      <strong>📍 Informace o místě</strong>
      <div class="kv" style="margin-top:8px;">
        <span><strong>Název:</strong></span><span id="info-name">—</span>
        <span><strong>GPS:</strong></span><span id="info-gps">—</span>
        <span><strong>Mapa LP:</strong></span><span><a id="bortle-link" href="#" target="_blank" style="display:none;color:#00ffc3;text-decoration:underline;font-weight:bold;">Zobrazit Bortle</a></span>
      </div>
    </div>

    <div class="panel">
      <strong>🔭 Astronomické informace</strong>
      <div style="margin-top:8px;">
        <div><strong>🌙 Fáze Měsíce:</strong> <span id="moon-phase-label">—</span></div>
        <div id="phase-raw" class="small" style="display:none;margin-top:4px;"></div>
      </div>
      <div style="margin-top:12px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <strong>🪐 Viditelné planety ~22:00</strong>
          <span id="planet-log" class="small" style="opacity:.85;"></span>
        </div>
        <div id="planets-list"></div>
      </div>
    </div>
  </div>

  <div class="right-col">
    <div class="panel" id="mapPanel">
      <div id="map"></div>
      <div id="mapZoomBadge" class="zoom-badge">Zoom: vypnuto</div>
      <div class="map-tip">Klikni <b>pravým</b> na mapu pro zapnutí/vypnutí zoomu</div>
    </div>
  </div>
</div>

<div class="spinner" id="spinner" style="margin-top:16px;"></div>
<div id="forecast" style="margin-top:8px;"></div>

<div class="footer">
  Zdroj fází: ipgeolocation.io • Počasí a geokódování: Open-Meteo • Planety: Astronomy Engine (fallback ipgeolocation) • Mapa: Leaflet & OSM
</div>

<script>
const IPGEO_API_KEY="781aa2d69af74745906e01cc68c84207";
const DEBUG=new URLSearchParams(location.search).has("debug");

/* Menu */
function toggleMenu(){const m=document.getElementById("mainMenu");m.style.display=m.style.display==="block"?"none":"block"}
document.addEventListener("click",(e)=>{const m=document.getElementById("mainMenu");const t=document.querySelector(".menu-toggle");if(m&&t&&!m.contains(e.target)&&!t.contains(e.target))m.style.display="none"});

/* Helpers */
const $=(id)=>document.getElementById(id);
function showSpinner(b){$("spinner").style.display=b?"block":"none"}
function getDayName(d){const today=new Date().toISOString().split('T')[0];if(d===today)return"Dnes";const arr=['Neděle','Pondělí','Úterý','Středa','Čtvrtek','Pátek','Sobota'];return arr[new Date(d).getDay()]}
function getWeatherIcon(c,r){if(r>2)return'🌧️';if(r>0)return'🌦️';if(c>75)return'☁️';if(c>25)return'🌤️';return'☀️'}

/* Layout sync */
function syncMapHeight(){
  const left=document.getElementById("leftTop");
  const mapPanel=document.getElementById("mapPanel");
  const mapDiv=document.getElementById("map");
  if(!left||!mapPanel||!mapDiv) return;
  const h=left.getBoundingClientRect().height;
  mapPanel.style.height=h+"px";
  mapDiv.style.height=h+"px";
  if(window._leafletMap){ setTimeout(()=> window._leafletMap.invalidateSize(), 100); }
}
const leftObserver = new MutationObserver(()=> syncMapHeight());
leftObserver.observe(document.getElementById("leftTop"), {subtree:true, childList:true, characterData:true});
window.addEventListener("resize", syncMapHeight);

/* Geocoding & selection */
let selectedCity=null;
async function autocompleteCities(){const v=$("cityInput").value.trim();const s=$("suggestions");if(v.length<2){s.style.display="none";return}const res=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(v)}&count=6&language=cs&format=json`);const data=await res.json();s.innerHTML="";(data.results||[]).forEach(c=>{const li=document.createElement("li");li.textContent=`${c.name}, ${c.country}`;li.onclick=()=>{selectedCity=c;$("cityInput").value=`${c.name}, ${c.country}`;updateLocationInfo(c);initMap(c.latitude,c.longitude);fetchForecast(c.latitude,c.longitude);fetchMoonPhase(c.latitude,c.longitude);fetchPlanets(c.latitude,c.longitude);s.style.display="none"};s.appendChild(li)});s.style.display=s.children.length?"block":"none"}

async function getLocation(){if(!navigator.geolocation)return alert("Váš prohlížeč nepodporuje geolokaci.");navigator.geolocation.getCurrentPosition(async p=>{const lat=p.coords.latitude,lon=p.coords.longitude;const name=await reverseGeocode(lat,lon);const c={name,country:"",latitude:lat,longitude:lon};selectedCity=c;updateLocationInfo(c);initMap(lat,lon);fetchForecast(lat,lon);fetchMoonPhase(lat,lon);fetchPlanets(lat,lon)},e=>alert("Nepodařilo se zjistit polohu."))}

async function reverseGeocode(lat,lon){try{const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`);const d=await r.json();return d.address?.city||d.address?.town||d.address?.village||d.address?.municipality||d.display_name||`${lat.toFixed(4)}, ${lon.toFixed(4)}`}catch{return `${lat.toFixed(4)}, ${lon.toFixed(4)}`}} 

function updateLocationInfo(c){const name=c.name||"-";const country=c.country||"";const lat=typeof c.latitude==="number"?c.latitude:null;const lon=typeof c.longitude==="number"?c.longitude:null;$("info-name").innerHTML=country?`<span style="color:#00ffc3;font-weight:bold;">${name}</span>, ${country}`:`<span style="color:#00ffc3;font-weight:bold;">${name}</span>`;$("info-gps").textContent=(lat!=null&&lon!=null)?`${lat.toFixed(4)}, ${lon.toFixed(4)}`:"—";const link=$("bortle-link");if(lat!=null&&lon!=null){link.href=`https://www.lightpollutionmap.info/#zoom=9&lat=${lat}&lon=${lon}`;link.style.display="inline"}else{link.style.display="none"}}

/* Map on the right */
let map=null,marker=null,zoomEnabled=false,zoomControl=null;
function initMap(lat,lon){
  syncMapHeight();
  if(!map){
    map=window._leafletMap = L.map('map', { zoomControl:false, scrollWheelZoom:false, touchZoom:false, doubleClickZoom:false, boxZoom:false, keyboard:false, dragging:true }).setView([lat,lon],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
    marker=L.marker([lat,lon]).addTo(map);
    map.on('contextmenu', function(){
      zoomEnabled = !zoomEnabled;
      const badge = $("mapZoomBadge");
      if(zoomEnabled){
        map.scrollWheelZoom.enable(); map.touchZoom.enable(); map.doubleClickZoom.enable(); map.boxZoom.enable(); map.keyboard.enable();
        if(!zoomControl){ zoomControl = L.control.zoom({position:'topleft'}).addTo(map); }
        if(badge) badge.textContent = "Zoom: zapnuto";
      } else {
        map.scrollWheelZoom.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable(); map.boxZoom.disable(); map.keyboard.disable();
        if(zoomControl){ map.removeControl(zoomControl); zoomControl=null; }
        if(badge) badge.textContent = "Zoom: vypnuto";
      }
    });
  } else {
    map.setView([lat,lon], 10);
    marker.setLatLng([lat,lon]);
  }
  setTimeout(()=> { map.invalidateSize(); syncMapHeight(); }, 150);
}

/* Moon phase (API, cz) */
function getMoonEmojiFromName(n){n=String(n||"").toLowerCase().replace(/_/g," ").trim();if(n.includes("new moon"))return"🌑 Nov";if(n.includes("waxing crescent"))return"🌒 Dorůstající srpek";if(n.includes("first quarter"))return"🌓 První čtvrť";if(n.includes("waxing gibbous"))return"🌔 Dorůstající měsíc";if(n.includes("full moon"))return"🌕 Úplněk";if(n.includes("waning gibbous"))return"🌖 Couvající měsíc";if(n.includes("last quarter"))return"🌗 Poslední čtvrť";if(n.includes("waning crescent"))return"🌘 Couvající srpek";return"🌙 Neznámá fáze"}
async function fetchMoonPhase(lat,lon){const url=`https://api.ipgeolocation.io/astronomy?apiKey=${IPGEO_API_KEY}&lat=${lat}&long=${lon}`;try{const r=await fetch(url);const d=await r.json();const p=d.moon_phase||"Neznámá fáze";$("moon-phase-label").textContent=getMoonEmojiFromName(p);if(DEBUG){$("phase-raw").style.display="block";$("phase-raw").textContent=`API: ${p}`}}catch(e){console.error("Chyba při načítání fáze:",e);$("moon-phase-label").textContent="Chyba načítání";$("phase-raw").textContent=""}}

/* === Star visibility graph support === */
let moonPhaseFracByDate = {};
function illuminationFromPhase(frac){ return 0.5 - 0.5*Math.cos(2*Math.PI*frac); } // 0..1
async function fetchMoonPhasesForecast(lat,lon){
  try{
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=moon_phase&timezone=Europe%2FPrague`;
    const res=await fetch(url);
    const data=await res.json();
    moonPhaseFracByDate = {};
    if(data?.daily?.time){
      for(let i=0;i<data.daily.time.length;i++){
        moonPhaseFracByDate[data.daily.time[i]] = data.daily.moon_phase[i];
      }
    }
  }catch(e){ console.warn("Moon phases forecast failed",e); moonPhaseFracByDate={}; }
}
function visibilityScore(cloud, precip, dateStr){
  const cloudScore = 100 - Math.min(Math.max(cloud,0),100);
  const rainPenalty = Math.min(precip*50, 50);
  const phase = moonPhaseFracByDate[dateStr] ?? 0;
  const illum = illuminationFromPhase(phase);
  const moonPenalty = illum * 40;
  const raw = cloudScore - rainPenalty - moonPenalty;
  return Math.max(0, Math.min(100, Math.round(raw)));
}
function drawBackgroundGraph(scrollEl, entries, dateStr){
  // Smazat starý graf uvnitř scrollu
  const old = scrollEl.querySelector('.bg-graph');
  if(old) old.remove();

  // Rozměry podle skutečně ZOBRAZENÝCH karet
  const totalW = scrollEl.scrollWidth;
  const totalH = scrollEl.clientHeight || 140;
  const midY = totalH/2;
  const amp = (totalH/2) * 0.9;
  const svgNS="http://www.w3.org/2000/svg";

  const wrap = document.createElement('div');
  wrap.className = "bg-graph";
  wrap.style.width = totalW + "px";
  wrap.style.height = totalH + "px";

  const svg = document.createElementNS(svgNS, 'svg');
  svg.setAttribute('width', totalW);
  svg.setAttribute('height', totalH);
  svg.style.display='block';

  // Baseline
  const baseline = document.createElementNS(svgNS, 'line');
  baseline.setAttribute('x1', 0); baseline.setAttribute('y1', midY);
  baseline.setAttribute('x2', totalW); baseline.setAttribute('y2', midY);
  baseline.setAttribute('stroke', 'rgba(255,255,255,0.2)');
  baseline.setAttribute('stroke-width', '1');
  svg.appendChild(baseline);

  const n = entries.length;
  if(n<2){ wrap.appendChild(svg); scrollEl.insertBefore(wrap, scrollEl.firstChild); return; }

  const points = [];
  for(let i=0;i<n;i++){
    const x = (totalW-1) * (i/(n-1));
    const score = visibilityScore(entries[i].cloud, entries[i].rain, dateStr); // 0..100
    const norm = score - 50; // -50..+50
    const y = midY - (norm/50)*amp;
    points.push([x,y]);
  }

  // Dvoubarevná výplň
  const makeAreaPath = (clampFn, fill) => {
    const dTop = points.map(([x,y],i)=> (i===0 ? `M ${x} ${clampFn(y)}` : `L ${x} ${clampFn(y)}`)).join(' ');
    const d = `${dTop} L ${points[n-1][0]} ${midY} L ${points[0][0]} ${midY} Z`;
    const p = document.createElementNS(svgNS, 'path');
    p.setAttribute('d', d);
    p.setAttribute('fill', fill);
    p.setAttribute('stroke', 'transparent');
    return p;
  };
  const greenArea = makeAreaPath(y => Math.min(y, midY), 'var(--greenFill)');
  const redArea   = makeAreaPath(y => Math.max(y, midY), 'var(--redFill)');
  svg.appendChild(greenArea);
  svg.appendChild(redArea);

  // Obrys
  const linePath = document.createElementNS(svgNS, 'path');
  const dLine = points.map(([x,y],i)=> (i===0 ? `M ${x} ${y}` : `L ${x} ${y}`)).join(' ');
  linePath.setAttribute('d', dLine);
  linePath.setAttribute('fill', 'none');
  linePath.setAttribute('stroke', 'rgba(255,255,255,0.6)');
  linePath.setAttribute('stroke-width', '1.5');
  svg.appendChild(linePath);

  wrap.appendChild(svg);
  // Vložit jako první – pod kartami a scrolluje se s nimi
  scrollEl.insertBefore(wrap, scrollEl.firstChild);
}

/* Forecast */
async function fetchForecast(lat,lon){
  showSpinner(true);
  await fetchMoonPhasesForecast(lat,lon);
  const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,cloudcover,precipitation,windspeed_10m&timezone=Europe/Prague`);
  const d=await r.json();
  showSpinner(false);
  const {time,temperature_2m,cloudcover,precipitation,windspeed_10m}=d.hourly;
  const div=$("forecast");div.innerHTML="";
  const days={};
  for(let i=0;i<time.length;i++){
    const [date,hour]=time[i].split('T');
    const h=parseInt(hour.split(':')[0]);
    if(!days[date]) days[date]=[];
    const entry={time:hour,temp:temperature_2m[i],cloud:cloudcover[i],rain:precipitation[i],wind:windspeed_10m[i],date};
    days[date].push(entry);
    if(h<12){
      const prev=new Date(date); prev.setDate(prev.getDate()-1); const prevStr=prev.toISOString().split('T')[0];
      if(!days[prevStr]) days[prevStr]=[];
      days[prevStr].push(entry);
    }
  }
  Object.entries(days).forEach(([date,entries],idx)=>{
    if(!entries.some(e=>parseInt(e.time.split(':')[0])>=12)) return;
    const section=document.createElement('div'); section.className='forecast-day';
    const header=document.createElement('h3'); const contentId=`day-${idx}`;
    header.dataset.date=date;
    header.innerHTML=`<span id="${contentId}-icon">⬆️</span> ${getDayName(date)}, ${date}
      <button class="btn" style="padding:4px 8px;font-size:.85em" onclick="event.stopPropagation(); centerTime('${contentId}', '12:00')">Poledne</button>
      <button class="btn" style="padding:4px 8px;font-size:.85em" onclick="event.stopPropagation(); centerTime('${contentId}', '23:00')">Půlnoc</button>`;
    header.onclick=()=>toggleForecast(contentId);
    section.appendChild(header);

    const content=document.createElement('div'); content.className='forecast-content'; content.id=contentId; content.style.display='block';
    const wrapper=document.createElement('div'); wrapper.className='forecast-scroll-wrapper';
    const leftBtn=document.createElement('button'); leftBtn.className='scroll-left'; leftBtn.textContent='◀';
    const rightBtn=document.createElement('button'); rightBtn.className='scroll-right'; rightBtn.textContent='▶';
    const scroll=document.createElement('div'); scroll.className='forecast-scroll';
    leftBtn.onclick=()=>scroll.scrollBy({left:-250,behavior:'smooth'});
    rightBtn.onclick=()=>scroll.scrollBy({left:250,behavior:'smooth'});
    wrapper.appendChild(leftBtn); wrapper.appendChild(scroll); wrapper.appendChild(rightBtn);

    const nowIso=new Date().toISOString().split('T')[0];

    /* === FIX: používat stejné zobrazené hodiny i pro graf === */
    const displayedEntries = entries.filter(e => (date !== nowIso) || (parseInt(e.time.split(':')[0]) >= new Date().getHours()));

    displayedEntries.forEach(e => {
      const card=document.createElement('div'); card.className='forecast-card';
      const icon=getWeatherIcon(e.cloud, e.rain);
      let color=e.cloud<=25?'green':(e.cloud<=75?'orange':'red');
      card.innerHTML=`<div><strong>${e.time}</strong></div>
                      <div style="font-size:1.4em">${icon}</div>
                      <div>${e.temp}°C</div>
                      <div>☁️ ${e.cloud}%</div>
                      <div>🌧️ ${e.rain} mm</div>
                      <div>💨 ${e.wind} km/h</div>
                      <div style="width: 100%; height: 8px; background-color: ${color}; border-radius: 4px; margin-top: 4px;"></div>`;
      scroll.appendChild(card);
    });

    content.appendChild(wrapper);
    section.appendChild(content);
    div.appendChild(section);

    // Kreslit graf jen pro ZOBRAZENÉ hodiny (řeší natahování u Dnes)
    requestAnimationFrame(()=> drawBackgroundGraph(scroll, displayedEntries, date));
  });
}

/* Toggle helpers */
function toggleForecast(id){const c=document.getElementById(id);const i=document.getElementById(id+'-icon');if(c.style.display==='none'){c.style.display='block';i.textContent='⬆️'}else{c.style.display='none';i.textContent='⬇️'}}
function centerTime(contentId,target){const sc=document.querySelector(`#${contentId} .forecast-scroll`);if(!sc)return;const cards=sc.querySelectorAll('.forecast-card');for(let i=0;i<cards.length;i++){const strong=cards[i].querySelector('strong');if(strong&&strong.textContent.trim()===target){const w=sc.clientWidth;const off=cards[i].offsetLeft;const cw=cards[i].offsetWidth;sc.scrollTo({left:off-(w/2)+(cw/2),behavior:'smooth'});break}}}

/* Planety @22:00 – AE (fallback API) */
async function fetchPlanets(lat,lon){
  const box=$("planets-list"); const log=(m)=>$("planet-log").textContent=m;
  box.innerHTML=""; log("počítám…");
  const render = (list) => {
    box.innerHTML="";
    let any=false;
    for(const p of list){
      if(Number.isFinite(p.alt)&&p.alt>5){
        const el=document.createElement("span"); el.className="pill"; el.title=`Azimut ${p.az.toFixed(0)}° v 22:00`; el.textContent=`${p.label}: ${p.alt.toFixed(0)}°`; box.appendChild(el); any=true;
      }
    }
    if(!any) box.innerHTML = `<span class="small">Žádné planety nejsou dobře viditelné v 22:00.</span>`;
    log("");
    syncMapHeight();
  };
  try{
    if(!window.Astronomy) throw new Error("Astronomy Engine nenačten");
    const Body=window.Astronomy.Body;
    const mapEnum = {Mercury:Body.Mercury, Venus:Body.Venus, Mars:Body.Mars, Jupiter:Body.Jupiter, Saturn:Body.Saturn, Uranus:Body.Uranus, Neptune:Body.Neptune};
    const now=new Date(); const t=new Date(now.getFullYear(), now.getMonth(), now.getDate(), 22, 0, 0);
    const obs=new window.Astronomy.Observer(lat, lon, 0);
    const names=[["Mercury","Merkur"],["Venus","Venuše"],["Mars","Mars"],["Jupiter","Jupiter"],["Saturn","Saturn"],["Uran","Uran"],["Neptune","Neptun"]];
    const out=[];
    for(const [eng, label] of names){
      const hor=window.Astronomy.Horizontal(t, obs, mapEnum[eng], 'normal');
      out.push({label, alt: hor.altitude, az: hor.azimuth});
    }
    render(out);
  }catch(e){
    console.warn("AE selhalo -> fallback API", e);
    try{
      const url=`https://api.ipgeolocation.io/astronomy?apiKey=${IPGEO_API_KEY}&lat=${lat}&long=${lon}`;
      const r=await fetch(url); const d=await r.json();
      const out=[
        {label:"Merkur", alt:+d.mercury_altitude, az:+d.mercury_azimuth},
        {label:"Venuše", alt:+d.venus_altitude,   az:+d.venus_azimuth},
        {label:"Mars",   alt:+d.mars_altitude,    az:+d.mars_azimuth},
        {label:"Jupiter",alt:+d.jupiter_altitude, az:+d.jupiter_azimuth},
        {label:"Saturn", alt:+d.saturn_altitude,  az:+d.saturn_azimuth},
        {label:"Uran",   alt:+d.uranus_altitude,  az:+d.uranus_azimuth},
        {label:"Neptun", alt:+d.neptune_altitude, az:+d.neptune_azimuth}
      ];
      render(out);
    }catch(err){
      box.innerHTML=`<span class="small">Chyba načítání planet.</span>`; log("");
    }
  }
}

/* Kick initial layout */
window.addEventListener('load', syncMapHeight);
</script>
</body>
</html>
